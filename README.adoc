= Open Policy Agent - Istio/Envoy integration
:toc:

Attempts to demonstrate support for: 

* JWT authentication for multiple IDPs
* RBAC on Endpoints for roles defined those JWTs


== Pre-requisites
A minimal installation of Istio is required, i.e. IstioD only. Please follow the steps in the Kong Istio Gateway instructions for more on doing a 'minimal' install.

Installation instructions for Kong Istio Gateway

* https://konghq.com/blog/istio-gateway


== Sidecar injection

The pattern being applied here is sidecar injection into the service pods of the Open Policy Agent Envoy plugin. 

image::https://github.com/open-policy-agent/opa-envoy-plugin/raw/main/examples/istio/arch.png[Side-car injection][opacity=0%]

The **__MutatingWebhook__** and **__Admission-controller__** objects are concerned with dynamically injecting the OPA Envoy plugin into the PODs, based on labels on the namespace:

[source,yaml,subs="verbatim,quotes"]
----
kind: Namespace
apiVersion: v1
metadata:
  name: opa-test
  labels:
    istio-injection: enabled
    **__opa-istio-injection: enabled__**
----


=== Mutating Webhook - (MutatingWebhookConfiguration)

The Mutating Webhook resource is watching namespaces with the `+opa-istio-injection+` label

[source,yaml,subs="verbatim,quotes"]
----
    namespaceSelector:
      matchLabels:
        **__opa-istio-injection: enabled__**
----

Within namespaces that match that label, it is looking for *pods* that have been *created* (TODO: this could be updated to inject for PODs that have been updated also?)
[source,yaml,subs="verbatim,quotes"]
----
    rules:
      **__- operations: ["CREATE"]__**
        apiGroups: [""]
        apiVersions: ["v1"]
        **__resources: ["pods"]__**
----

For pods that meet that criteria, the MutatingWebhook resource then calls into the the web hook(admission-controller) in the `+opa-istio+` namespace
[source,yaml,subs="verbatim,quotes"]
----
    clientConfig:
      service:
        name: admission-controller
        namespace: opa-istio
        path: "/v0/data/istio/inject"
----

See the 
https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-configuration[MutatingWebhookConfiguration] Kubernetes docs for more detail on this functionality


=== Web hook/admission-controller
The `+admission-controller+` deployment in the `+opa-istio+` namespace is only concerned with injecting the OPA Envoy plugin sidecar container into the Pods that the have met the criteria defined in the `+MutatingWebhookConfiguration+`.
The configuration of the injected container is determined by the `+inject.rego+` file which is mounted in the `+inject-policy+` ConfigMap.

E.g.

[source,json,subs="verbatim,quotes"]
----
    opa_container = {
      "image": "openpolicyagent/opa:0.45.0-istio",
      "name": "opa-istio",
      "args": [
        "run",
        "--server",
        "--config-file=/config/config.yaml",
        "--addr=localhost:8181",
        "--diagnostic-addr=0.0.0.0:8282",
        "/policies/policy.rego",
        "/policies/common.rego",
        "/policies/data.json",
      ]
    }
----

The logic here is also labelling the pod with `+opa-istio-injection: enabled+`. This is done so that EnvoyFilter knows which pods have been injected with the OPA sidecar. TODO: review functionality

[source,json,subs="verbatim,quotes"]
----
     {
      "op": "add",
      "path": "/metadata/labels/opa-istio-injection",
      "value": "enabled" }
----


=== EnvoyFilter

As per the https://istio.io/latest/docs/reference/config/networking/envoy-filter/[Istio docs], the EnvoyFilter is concerned with:
[quote,Istio docs]
====
"providing a mechanism to customize the Envoy configuration generated by Istio Pilot. Use EnvoyFilter to modify values for certain fields, *add specific filters*, or even add entirely new listeners, clusters, etc."
====


In this case this configuration is using the https://www.envoyproxy.io/docs/envoy/v1.16.0/configuration/http/http_filters/ext_authz_filter#config-http-filters-ext-authz/[External Authorization] HTTP filter. From the docs:
[quote,Envoy docs]
====
"The external authorization filter calls an external gRPC or HTTP service to check whether an incoming HTTP request is authorized or not. If the request is deemed unauthorized, then the request will be denied normally with 403 (Forbidden) response."
====

In this configuration, the filter is calling into the OPA envoy plugin (side car), to "authorize" the request.


The configuration of the Envoyfilter is only applied to Pods with the `+opa-istio-injection: enabled+` label.

[source,yaml,attributes]
----
  workloadSelector:
    labels:
      opa-istio-injection: enabled
----

=== Infrastructure deployment      
[source,console,attributes]
----
kubectl apply -f opa-envoy.yaml
----



== Sample deployment

=== Required Annotations 

[source,bash,attributes]
----
kubectl apply -k sample-application -n opa-test
----


=== Caveats, Limitations,TODOs


* Having to restart pods that pre-existed OPA deployment
* Identify edge cases that should be tested, i.e invalid rego, etc


=== References

_Documentation:_

* https://www.openpolicyagent.org/docs/latest/envoy-introduction/[OPA docs]
* https://www.openpolicyagent.org/docs/latest/envoy-tutorial-istio/[OPA tutorial]
* https://github.com/open-policy-agent/opa-envoy-plugin[OPA Envoy plugin]


_Examples:_

* https://github.com/open-policy-agent/opa-envoy-plugin/tree/main/examples/istio[Official quick start]





